<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Distributed · STLCutters.jl</title><meta name="title" content="Distributed · STLCutters.jl"/><meta property="og:title" content="Distributed · STLCutters.jl"/><meta property="twitter:title" content="Distributed · STLCutters.jl"/><meta name="description" content="Documentation for STLCutters.jl."/><meta property="og:description" content="Documentation for STLCutters.jl."/><meta property="twitter:description" content="Documentation for STLCutters.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">STLCutters.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction</a></li><li><a class="tocitem" href="../usage/">Usage</a></li><li class="is-active"><a class="tocitem" href>Distributed</a><ul class="internal"><li><a class="tocitem" href="#Introduction"><span>Introduction</span></a></li><li><a class="tocitem" href="#Underlying-distributed-algorithms"><span>Underlying distributed algorithms</span></a></li><li><a class="tocitem" href="#Multi-threading-usage"><span>Multi-threading usage</span></a></li><li><a class="tocitem" href="#Distributed-memory-usage"><span>Distributed memory usage</span></a></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../public_api/">Public API</a></li><li><a class="tocitem" href="../types/">Private types</a></li><li><a class="tocitem" href="../functions/">Private functions</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Distributed</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Distributed</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/gridap/STLCutters.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/gridap/STLCutters.jl/blob/main/docs/src/distributed.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Distributed"><a class="docs-heading-anchor" href="#Distributed">Distributed</a><a id="Distributed-1"></a><a class="docs-heading-anchor-permalink" href="#Distributed" title="Permalink"></a></h1><h2 id="Introduction"><a class="docs-heading-anchor" href="#Introduction">Introduction</a><a id="Introduction-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction" title="Permalink"></a></h2><p>When dealing with large-scale problems, this package can be accelerated through two types of parallelization. The first one is multi-threading, which uses <a href="https://docs.julialang.org/en/v1/base/multi-threading/">Julia Threads</a> for shared memory parallelization (e.g., <code>julia -t 4</code>). This method adds some speed-up. However, it is only efficient for a reduced number of threads.</p><p>The second one is a distributed memory computing. For such parallelization, we use MPI (<code>mpiexec -np 4 julia input.jl</code>) through <a href="https://www.francescverdugo.com/PartitionedArrays.jl/stable"><code>PartitionedArrays</code></a> and <a href="https://gridap.github.io/GridapDistributed.jl/dev/"><code>GridapDistributed</code></a>. With MPI we can compute large-scale problems efficiently, up to thousands of cores.</p><p>Additionally, the distributed memory implementation is built on top of <a href="https://github.com/gridap/GridapEmbedded.jl">GridapEmbedded</a>. GridapEmbedded provides parallelization tools since <a href="https://github.com/gridap/GridapEmbedded.jl/releases/tag/v0.9.2">v0.9.2</a>.</p><h2 id="Underlying-distributed-algorithms"><a class="docs-heading-anchor" href="#Underlying-distributed-algorithms">Underlying distributed algorithms</a><a id="Underlying-distributed-algorithms-1"></a><a class="docs-heading-anchor-permalink" href="#Underlying-distributed-algorithms" title="Permalink"></a></h2><p>The implementation of multi-threading is straightforwardly applied to the embarrassingly parallel loops. However, the distributed memory implementation requires more involved algorithms for the global computations, e.g., the classification of the background cells as inside or outside. These algorithms are described in Chapter 4 of the following PhD thesis.</p><blockquote><p>Pere A. Martorell. &quot;Unfitted finite element methods for explicit boundary representations&quot;. PhD Thesis. Universitat Politècnica de Catalunya. 2024. <a href="https://www.tdx.cat/handle/10803/690625">hdl.handle.net/10803/690625</a></p></blockquote><h2 id="Multi-threading-usage"><a class="docs-heading-anchor" href="#Multi-threading-usage">Multi-threading usage</a><a id="Multi-threading-usage-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-threading-usage" title="Permalink"></a></h2><p>The usage of this package with multi-threading is the same as for the serial case (see <a href="../usage/#Serial-example">Serial example</a>). The user only needs to set the number of threads when initializing Julia. E.g.,</p><pre><code class="language-bash hljs">julia -threads 4 </code></pre><h2 id="Distributed-memory-usage"><a class="docs-heading-anchor" href="#Distributed-memory-usage">Distributed memory usage</a><a id="Distributed-memory-usage-1"></a><a class="docs-heading-anchor-permalink" href="#Distributed-memory-usage" title="Permalink"></a></h2><p>The distributed usage needs to be set up at the driver level. The user needs to install and load <code>MPI.jl</code>, <code>PartitionedArrays.jl</code>, and <code>GridapDistributed.jl</code>. </p><p>Here, we provide a basic example of solving the Poisson equation with distributed STLCutters with 8 MPI tasks. Run the following command.</p><pre><code class="language-bash hljs">mpiexec -np 8 julia poisson.jl</code></pre><p>Where <code>poisson.jl</code> is the following code.</p><pre><code class="language-julia hljs">using STLCutters
using Gridap
using GridapEmbedded
using GridapDistributed
using PartitionedArrays
using MPI

parts = (2,2,2)
cells = (10,10,10)
filename = &quot;stl_file_path.stl&quot;

with_mpi() do distribute
  ranks = distribute(LinearIndices((prod(parts),)))
  # Domain and discretization
  geo = STLGeometry(filename)
  pmin,pmax = get_bounding_box(geo)
  model = CartesianDiscreteModel(ranks,parts,pmin,pmax,cells)
  cutgeo = cut(model,geo)
  # Cell aggregation
  model,cutgeo,aggregates = aggregate(AggregateAllCutCells(),cutgeo)
  # Triangulations
  Ω_act = Triangulation(cutgeo,ACTIVE)
  Ω = Triangulation(cutgeo)
  Γ = EmbeddedBoundary(cutgeo)
  nΓ = get_normal_vector(Γ)   
  dΩ = Measure(Ω,2)
  dΓ = Measure(Γ,2)
  # FE spaces
  Vstd = TestFESpace(Ω_act,ReferenceFE(lagrangian,Float64,1))
  V = AgFEMSpace(model,Vstd,aggregates)
  U = TrialFESpace(V)
  # Weak form
  γ = 10.0
  h = (pmax - pmin)[1] / cells[1]
  ud(x) = x[1] - x[2]
  f = 0
  a(u,v) =
    ∫( ∇(v)⋅∇(u) )dΩ +
    ∫( (γ/h)*v*u  - v*(nΓ⋅∇(u)) - (nΓ⋅∇(v))*u )dΓ
  l(v) =
    ∫( v*f )dΩ +
    ∫( (γ/h)*v*ud - (nΓ⋅∇(v))*ud )dΓ
  # Solve
  op = AffineFEOperator(a,l,U,V)
  uh = solve(op)
  writevtk(Ω,&quot;results&quot;,cellfields=[&quot;uh&quot;=&gt;uh])
end</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The STL file can be downloaded using <a href="../public_api/#STLCutters.download_thingi10k"><code>download_thingi10k</code></a>.</p></div></div><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>It is recommended to use <code>with_debug()</code> instead of <code>with_mpi()</code> for debugging in serialized execution, see more details in <a href="https://www.francescverdugo.com/PartitionedArrays.jl/stable"><code>PartitionedArrays</code></a>.</p></div></div><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>One can consider a different stabilization of the small cut-cell problem instead of AgFEM. Then, the <code>aggregate</code> and <code>AgFEMSpace</code> need to be removed. See more examples in <a href="https://github.com/gridap/GridapEmbedded.jl"><code>GridapEmbedded</code></a></p></div></div><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Even though the distributed algorithms are proven to be efficient for large-scale weak scaling tests <a href="https://www.tdx.cat/handle/10803/690625">Martorell, 2024</a>. The performance of this implementation is not tested.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../usage/">« Usage</a><a class="docs-footer-nextpage" href="../public_api/">Public API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Thursday 11 July 2024 15:06">Thursday 11 July 2024</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
